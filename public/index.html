<!DOCTYPE html>
<html>
  <head>
    <title>Ruby on Rails: Welcome aboard</title>
    <style>
      #dropArea {
      width: 400px;
      height: 300px;
      border: 1px solid grey;
      background: pink;
      float: left;
      }
      #dropArea .over {
        border: 3px dashed #000;
      }
    </style>
</head>
  </body>
<article>
  <style scoped>
    video { transform: scaleX(-1); 
      width: 400px;
      height: 300px;
    }
    p { text-align: center; }
    canvas {
    margin: 2px;
    }
  </style>
  <h1>FrameInIt</h1>
  <section id="splash">
    <p id="errorMessage">Loading...</p>
  </section>
  <section id="app" hidden>
    <div id="dropArea" >Drop Here
    </div>
    <p><video id="monitor" autoplay></video> 
    <p><input type=button value="Shoot" onclick="snapShot()">
  </section>
  <section>
    <span id = "snapshots"> </span>
  </section>
</article>
<script>
  // this is redone code from http://dev.w3.org/2011/webrtc/editor/getusermedia.html
  navigator.getMedia = ( navigator.getUserMedia || navigator.webkitGetUserMedia ||
                         navigator.mozGetUserMedia || navigator.msGetUserMedia);
  navigator.getMedia({
    video: true
    // ,audio: true //want some audio??
  }, gotStream, noStream);
   
   var video = document.getElementById('monitor');
   // var canvas = document.getElementById('photo');

   function gotStream(stream) {
    if (navigator.mozGetUserMedia) {
        video.mozSrcObject = stream;
       } else {
          var vendorURL = window.URL || window.webkitURL;
          video.src = vendorURL.createObjectURL(stream);
        }
       // video.play();
       //video.onloadedmetadata = function () {
              document.getElementById('splash').hidden = true;
              document.getElementById('app').hidden = false;
       //};
   }

   function noStream() {
       document.getElementById('errorMessage').textContent = 'No camera available.';
   }
  //downloading pictures
    var download = function(e){
        var eTarget = e.target || e.srcElement;
        var image = eTarget.toDataURL("image/png").replace("image/png", "image/octet-stream");
        window.location.href=image; 
    } 
  //end downloading pictures
   var takeShot = function(){
    if (video.readyState) {
        t=setTimeout(function(){
          try {
          //create new canvas element 
            var snap = document.createElement("canvas");
          //change size of snapshot
            canvasW = video.videoWidth /4 ;
            canvasH = video.videoHeight /4;
            snap.setAttribute('width',canvasW);
            snap.setAttribute('height',canvasH);
            snap.getContext('2d').drawImage(video,0,0,canvasW,canvasH);
            snap.setAttribute('draggable', 'true');
            snap.classList.add("smallpic");
            snap.addEventListener("dblclick",download); //double click to download picture
            document.getElementById("snapshots").appendChild(snap);
          } catch (e) {
              document.getElementById('splash').hidden = false;
              errorMessage.textContent = "Splash! Something went wrong..." + e;
            }
          takeShot();
        },1000);
      }
   }

   
   var snapShot = function() {
    if(document.getElementsByTagName('input')[0].value == "Shoot"){
      document.getElementsByTagName('input')[0].value="Stop";
      takeShot();
    }else{
      clearTimeout(t)
      document.getElementsByTagName('input')[0].value="Shoot";
    }


    //draggable events

    function handleDragStart(e) {
      this.style.opacity = '0.4';  // this / e.target is the source node.
 
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('text/html', this.innerHTML);

      var area = document.getElementById('dropArea');
      area.setAttribute('style', 'background:grey');
    }

    function handleDragEnd(e) {
      this.style.opacity = '1'; 
      var area = document.getElementById('dropArea');
      area.setAttribute('style', 'background:pink'); // this / e.target is the source node.
    }

    function handleDragEnter(e) {
      // this / e.target is the current hover target.
      var area = document.getElementById('dropArea');
      area.setAttribute('style', 'background:blue');
      //area.classList.add('over');
    }

    function handleDragLeave(e) {
      //this.classList.remove('over');  // this / e.target is previous target element.
      var area = document.getElementById('dropArea');
      //area.setAttribute('style', 'background:pink');
      //area.classList.remove'over');
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault(); // Necessary. Allows us to drop.
      }

      e.dataTransfer.dropEffect = 'copy';  // See the section on the DataTransfer object.

      return false;
    }

    function handleDrop(e) {
      // this / e.target is current target element.

      if (e.stopPropagation) {
        e.stopPropagation(); // stops the browser from redirecting.
      }

      // Don't do anything if dropping the same column we're dragging.
      //if (dragSrcEl != this) {
        // Set the source column's HTML to the HTML of the column we dropped on.
        document.getElementById('dropArea').innerHTML = this.innerHTML;
        this.innerHTML = e.dataTransfer.getData('text/html');
      //}
       //var src = ev.dataTransfer.getData('text/html');
       //e.target.appendChild(document.getElementById(src));
       //e.stopPropagation();
       return false;

    }

    //add draggable event listeners to the small pictures
    var pics = document.getElementsByClassName('smallpic');
    var numpics = pics.length;
    for(var i = 0; i < numpics ; i++){
      pics[i].addEventListener('dragstart', handleDragStart, false);
      //pics[i].addEventListener('dragenter', handleDragEnter, false);
      pics[i].addEventListener('dragover', handleDragOver, false);
      pics[i].addEventListener('dragleave', handleDragLeave, false);
      //pics[i].addEventListener('drop', handleDrop, false);
      pics[i].addEventListener('dragend', handleDragEnd, false);
      
    }
    var area = document.getElementById('dropArea');
    area.addEventListener('dragenter', handleDragEnter, false);
    area.addEventListener('drop', handleDrop, false);
    //end drag 
   
   
 }
 </script>
  </body>
</html>
